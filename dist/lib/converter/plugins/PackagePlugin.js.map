{"version":3,"file":"PackagePlugin.js","sourceRoot":"","sources":["../../../../src/lib/converter/plugins/PackagePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Path from 'path';\r\nimport * as FS from 'fs';\r\nimport * as ts from 'typescript';\r\n\r\nimport { Reflection } from '../../models/reflections/abstract';\r\nimport { Component, ConverterComponent } from '../components';\r\nimport { Converter } from '../converter';\r\nimport { Context } from '../context';\r\nimport { Option } from '../../utils/component';\r\n\r\n/**\r\n * A handler that tries to find the package.json and readme.md files of the\r\n * current project.\r\n *\r\n * The handler traverses the file tree upwards for each file processed by the processor\r\n * and records the nearest package info files it can find. Within the resolve files, the\r\n * contents of the found files will be read and appended to the ProjectReflection.\r\n */\r\n@Component({name: 'package'})\r\nexport class PackagePlugin extends ConverterComponent {\r\n    @Option({\r\n        name: 'readme',\r\n        help: 'Path to the readme file that should be displayed on the index page. Pass `none` to disable the index page and start the documentation on the globals page.'\r\n    })\r\n    readme!: string;\r\n\r\n    /**\r\n     * The file name of the found readme.md file.\r\n     */\r\n    private readmeFile?: string;\r\n\r\n    /**\r\n     * The file name of the found package.json file.\r\n     */\r\n    private packageFile?: string;\r\n\r\n    /**\r\n     * List of directories the handler already inspected.\r\n     */\r\n    private visited!: string[];\r\n\r\n    /**\r\n     * Should the readme file be ignored?\r\n     */\r\n    private noReadmeFile?: boolean;\r\n\r\n    /**\r\n     * Create a new PackageHandler instance.\r\n     */\r\n    initialize() {\r\n        this.listenTo(this.owner, {\r\n            [Converter.EVENT_BEGIN]:         this.onBegin,\r\n            [Converter.EVENT_FILE_BEGIN]:    this.onBeginDocument,\r\n            [Converter.EVENT_RESOLVE_BEGIN]: this.onBeginResolve\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Triggered when the converter begins converting a project.\r\n     *\r\n     * @param context  The context object describing the current state the converter is in.\r\n     */\r\n    private onBegin(context: Context) {\r\n        this.readmeFile = undefined;\r\n        this.packageFile = undefined;\r\n        this.visited = [];\r\n\r\n        let readme = this.readme;\r\n        this.noReadmeFile = (readme === 'none');\r\n        if (!this.noReadmeFile && readme) {\r\n            readme = Path.resolve(readme);\r\n            if (FS.existsSync(readme)) {\r\n                this.readmeFile = readme;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Triggered when the converter begins converting a source file.\r\n     *\r\n     * @param context  The context object describing the current state the converter is in.\r\n     * @param reflection  The reflection that is currently processed.\r\n     * @param node  The node that is currently processed if available.\r\n     */\r\n    private onBeginDocument(context: Context, reflection: Reflection, node?: ts.SourceFile) {\r\n        if (!node) {\r\n            return;\r\n        }\r\n        if (this.readmeFile && this.packageFile) {\r\n            return;\r\n        }\r\n\r\n        const fileName = node.fileName;\r\n        let dirName: string, parentDir = Path.resolve(Path.dirname(fileName));\r\n        do {\r\n            dirName = parentDir;\r\n            if (this.visited.indexOf(dirName) !== -1) {\r\n                break;\r\n            }\r\n\r\n            FS.readdirSync(dirName).forEach((file) => {\r\n                const lfile = file.toLowerCase();\r\n                if (!this.noReadmeFile && !this.readmeFile && lfile === 'readme.md') {\r\n                    this.readmeFile = Path.join(dirName, file);\r\n                }\r\n\r\n                if (!this.packageFile && lfile === 'package.json') {\r\n                    this.packageFile = Path.join(dirName, file);\r\n                }\r\n            });\r\n\r\n            this.visited.push(dirName);\r\n            parentDir = Path.resolve(Path.join(dirName, '..'));\r\n        } while (dirName !== parentDir);\r\n    }\r\n\r\n    /**\r\n     * Triggered when the converter begins resolving a project.\r\n     *\r\n     * @param context  The context object describing the current state the converter is in.\r\n     */\r\n    private onBeginResolve(context: Context) {\r\n        const project = context.project;\r\n        if (this.readmeFile) {\r\n            project.readme = FS.readFileSync(this.readmeFile, 'utf-8');\r\n        }\r\n\r\n        if (this.packageFile) {\r\n            project.packageInfo = JSON.parse(FS.readFileSync(this.packageFile, 'utf-8'));\r\n            if (!project.name) {\r\n                project.name = project.packageInfo.name;\r\n            }\r\n        }\r\n    }\r\n}\r\n"]}